<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>OptiClaims ‚Äî Executive Dashboard</title>
  <style>
    :root {
      /* Palette Professionnelle (Slate & Indigo) */
      --bg-body: #f1f5f9;
      --bg-surface: #ffffff;
      --bg-subtle: #f8fafc;
      
      --text-main: #0f172a;
      --text-muted: #64748b;
      --text-light: #94a3b8;

      --primary: #4f46e5;       /* Indigo 600 */
      --primary-soft: #eef2ff;
      --accent: #0ea5e9;        /* Sky 500 */
      --success: #10b981;
      --danger: #ef4444;
      --border: #e2e8f0;
      
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-drawer: -5px 0 25px rgba(0,0,0,0.1);

      --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
      
      --radius: 12px;
    }

    /* Dark Mode Variables */
    [data-theme="dark"] {
      --bg-body: #0f172a;
      --bg-surface: #1e293b;
      --bg-subtle: #334155;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --text-light: #64748b;
      --border: #334155;
      --primary-soft: #1e1b4b;
      --shadow-drawer: -5px 0 25px rgba(0,0,0,0.5);
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-body);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: background-color 0.3s, color 0.3s;
    }

    /* --- Header & KPIs --- */
    .topbar {
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      z-index: 20;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand-logo {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: 8px;
      display: grid; place-items: center;
      color: white; font-weight: bold; font-size: 18px;
    }
    .brand-text h1 { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
    .brand-text span { font-size: 12px; color: var(--text-muted); font-weight: 500; }

    .controls { display: flex; gap: 12px; align-items: center; }

    .search-wrap { position: relative; }
    .search-wrap input {
      padding: 8px 12px 8px 36px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-body);
      color: var(--text-main);
      width: 240px;
      font-size: 13px;
      transition: all 0.2s;
    }
    .search-wrap input:focus { border-color: var(--primary); width: 300px; box-shadow: 0 0 0 3px var(--primary-soft); }
    .search-icon {
      position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
      color: var(--text-light); font-size: 14px; pointer-events: none;
    }

    .btn {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-surface);
      color: var(--text-main);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      transition: all 0.2s;
    }
    .btn:hover { background: var(--bg-subtle); border-color: var(--text-muted); }
    .btn-primary { background: var(--primary); color: white; border: none; }
    .btn-primary:hover { background: #4338ca; border: none; }
    
    .progress-strip {
      height: 4px;
      width: 100%;
      background: var(--border);
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      width: 0%;
      transition: width 1s ease;
    }

    /* --- Board Layout --- */
    .board-container {
      flex: 1;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 24px;
      display: flex;
      gap: 20px;
      scroll-behavior: smooth;
    }

    .stage-col {
      min-width: 340px;
      max-width: 340px;
      display: flex;
      flex-direction: column;
      height: 100%;
      background: transparent;
    }

    .stage-header {
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 4px;
    }
    .stage-title {
      font-weight: 700;
      font-size: 14px;
      color: var(--text-main);
      display: flex; align-items: center; gap: 8px;
    }
    .stage-badge {
      background: var(--bg-subtle);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
    }
    
    .stage-body {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px; /* Space for scrollbar */
      padding-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    /* Scrollbar styling */
    .stage-body::-webkit-scrollbar { width: 6px; }
    .stage-body::-webkit-scrollbar-track { background: transparent; }
    .stage-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .stage-body::-webkit-scrollbar-thumb:hover { background: var(--text-light); }

    /* --- Cards --- */
    .ticket-card {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    }
    .ticket-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--primary);
    }
    
    .card-top { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .card-id {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-body);
      padding: 2px 6px;
      border-radius: 4px;
    }
    .card-duration {
      font-size: 11px;
      font-weight: 600;
      color: var(--primary);
      background: var(--primary-soft);
      padding: 2px 8px;
      border-radius: 12px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      line-height: 1.4;
      margin-bottom: 8px;
      color: var(--text-main);
    }

    .card-desc {
      font-size: 13px;
      color: var(--text-muted);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .card-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
      font-size: 12px;
      color: var(--text-light);
    }
    .meta-item { display: flex; align-items: center; gap: 4px; }

    /* --- Drawer (Slide-Over) --- */
    .drawer-backdrop {
      position: fixed; inset: 0;
      background: rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(2px);
      z-index: 100;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }
    .drawer-backdrop.open { opacity: 1; pointer-events: auto; }

    .drawer {
      position: fixed; top: 0; right: 0; bottom: 0;
      width: 600px;
      max-width: 90vw;
      background: var(--bg-surface);
      z-index: 101;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: var(--shadow-drawer);
      display: flex;
      flex-direction: column;
    }
    .drawer.open { transform: translateX(0); }

    .drawer-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .drawer-title-group h2 { margin: 0 0 4px 0; font-size: 18px; color: var(--text-main); }
    .drawer-subtitle { font-family: var(--font-mono); font-size: 12px; color: var(--text-muted); }
    
    .drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .detail-section { margin-bottom: 24px; }
    .detail-label {
      text-transform: uppercase;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.5px;
      color: var(--text-light);
      margin-bottom: 8px;
    }
    .detail-text { font-size: 14px; line-height: 1.6; color: var(--text-muted); }

    .todo-list { list-style: none; padding: 0; margin: 0; }
    .todo-item {
      display: flex; align-items: flex-start; gap: 10px;
      padding: 8px 0; border-bottom: 1px solid var(--border);
    }
    .todo-item:last-child { border-bottom: none; }
    .todo-check {
      min-width: 16px; height: 16px;
      border: 2px solid var(--text-light);
      border-radius: 4px;
      margin-top: 3px;
    }
    
    .code-block {
      background: var(--bg-body);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 10px;
    }
    .code-header {
      padding: 8px 12px;
      background: var(--bg-subtle);
      border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
      font-size: 12px; color: var(--text-muted);
    }
    pre {
      margin: 0; padding: 16px;
      overflow-x: auto;
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--primary);
    }

    .drawer-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex; justify-content: space-between;
      background: var(--bg-subtle);
    }

    /* Utilities */
    .badge { display: inline-block; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 600; }
    .badge-blue { background: #dbeafe; color: #1e40af; }
    .hidden { display: none !important; }
    
  </style>
</head>
<body data-theme="light">

  <header class="topbar">
    <div class="brand">
      <div class="brand-logo">O</div>
      <div class="brand-text">
        <h1>OptiClaims</h1>
        <span>Engineering Dashboard</span>
      </div>
    </div>
    
    <div class="controls">
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" placeholder="Rechercher un ticket, une API..." />
      </div>
      <div style="width: 1px; height: 24px; background: var(--border); margin: 0 8px;"></div>
      <button class="btn" id="themeToggle">üåó Th√®me</button>
      <button class="btn btn-primary" onclick="alert('Fonctionnalit√© export √† venir')">Export PDF</button>
    </div>
  </header>

  <div class="progress-strip">
    <div class="progress-fill" id="globalProgress"></div>
  </div>

  <main class="board-container" id="boardContainer">
    </main>

  <div class="drawer-backdrop" id="drawerBackdrop"></div>
  <aside class="drawer" id="ticketDrawer">
    <div class="drawer-header">
      <div class="drawer-title-group">
        <h2 id="d-title">Ticket Title</h2>
        <span class="drawer-subtitle" id="d-id">ID: 1.1</span>
      </div>
      <button class="btn" id="closeDrawer">‚úï</button>
    </div>
    <div class="drawer-content">
      
      <div class="detail-section">
        <div class="detail-label">Objectif</div>
        <div class="detail-text" id="d-desc">Description text here...</div>
      </div>

      <div class="detail-section">
        <div class="detail-label">T√¢ches √† r√©aliser</div>
        <ul class="todo-list" id="d-todos"></ul>
      </div>

      <div class="detail-section">
        <div class="detail-label">Impl√©mentation Technique (Code Blocks)</div>
        <div id="d-code"></div>
      </div>

    </div>
    <div class="drawer-footer">
      <button class="btn" style="color:var(--danger); border-color:var(--danger)" id="btnDelete">Supprimer ce ticket</button>
      <div style="font-size:12px; color:var(--text-muted); display:flex; align-items:center;">
        Statut: <strong style="margin-left:4px">√Ä faire</strong>
      </div>
    </div>
  </aside>

<script>
/* --- DATA --- */
const DATA = {"tickets": [{"ticket_id": "1.1", "ticket_title": "Mock API Salesforce - R√©cup√©ration Data", "duration": "0.5j", "description": "Cr√©er un mock de l'API Salesforce qui retourne documents + JSON des champs √† remplir bas√© sur record_id", "stage_num": "1", "stage_title": "Endpoint R√©cup√©ration Data Salesforce", "todos": ["Cr√©er route POST `/mock/salesforce/get-record-data`", "D√©finir le format de r√©ponse JSON :", "Cr√©er 3-5 datasets mock pour diff√©rents types de records", "Impl√©menter la logique de s√©lection du mock selon record_id", "Ajouter gestion d'erreurs (record_id invalide)", "Tester avec diff√©rents record_id"], "code_blocks": []}, {"ticket_id": "1.2", "ticket_title": "Endpoint MCP - Request Salesforce Data", "duration": "0.5j", "description": "Endpoint r√©el qui appelle le mock Salesforce et retourne la data format√©e", "stage_num": "1", "stage_title": "Endpoint R√©cup√©ration Data Salesforce", "todos": ["Cr√©er route POST `/api/mcp/request-salesforce-data`", "Param√®tres d'entr√©e : `{\"record_id\": \"001XXXX\"}`", "Impl√©menter `fetch_salesforce_data(record_id)` ‚Üí appel au mock", "Valider la structure de la r√©ponse re√ßue", "Ajouter logging : `[INFO] Data fetched for record_id: {record_id}`", "G√©rer timeout et erreurs de connexion", "Retourner JSON standardis√© avec status code appropri√©", "Tester avec Postman/curl"], "code_blocks": []}, {"ticket_id": "2.1", "ticket_title": "Infrastructure Session Storage", "duration": "0.5j", "description": "Mettre en place Redis/DB pour stocker et g√©rer les sessions", "stage_num": "2", "stage_title": "Syst√®me de Gestion de Session", "todos": ["Installer et configurer Redis (ou alternative PostgreSQL)", "D√©finir le sch√©ma de session :", "Cr√©er les fonctions CRUD :", "`create_session(record_id, context)` ‚Üí retourne session_id", "`get_session(session_id)` ‚Üí retourne session object", "`update_session(session_id, updates)`", "`delete_session(session_id)`", "Configurer TTL (Time To Live) : 24h par d√©faut", "Tester cr√©ation, r√©cup√©ration et expiration"], "code_blocks": []}, {"ticket_id": "2.2", "ticket_title": "Session Manager Service", "duration": "0.5j", "description": "Classe de service pour g√©rer la logique m√©tier des sessions", "stage_num": "2", "stage_title": "Syst√®me de Gestion de Session", "todos": ["Cr√©er classe `SessionManager`", "Impl√©menter `initialize_session(record_id, salesforce_data)` :", "G√©n√®re session_id unique (UUID)", "Stocke context initial (documents + fields)", "Retourne session_id", "D√©velopper `check_session_exists(session_id)` ‚Üí bool", "Cr√©er `append_message_to_history(session_id, role, message)`", "Impl√©menter `get_session_context(session_id)` ‚Üí context complet", "Ajouter `extend_session_ttl(session_id)` ‚Üí reset expiration", "Tester tous les sc√©narios (nouvelle session, session existante, session expir√©e)"], "code_blocks": []}, {"ticket_id": "3.1", "ticket_title": "Mock API Salesforce Apex - Envoi Request", "duration": "0.5j", "description": "Mock de l'API Apex qui envoie record_id, session_id, user_request", "stage_num": "3", "stage_title": "Endpoint R√©ception User Request", "todos": ["Cr√©er route POST `/mock/apex/send-user-request`", "D√©finir le format d'envoi :", "Cr√©er 5-10 exemples de user_request r√©alistes :", "\"Remplis tous les champs manquants\"", "\"Quel est le montant sur la facture ?\"", "\"Corrige la date, elle semble incorrecte\"", "\"Extraire les informations du b√©n√©ficiaire\"", "Simuler cas o√π session_id = null (nouvelle conversation)", "Simuler cas o√π session_id existe (conversation continue)", "Tester l'envoi avec diff√©rentes combinaisons"], "code_blocks": []}, {"ticket_id": "3.2", "ticket_title": "Endpoint MCP - Receive User Request", "duration": "0.5j", "description": "Endpoint qui re√ßoit les donn√©es d'Apex et les pr√©pare pour traitement", "stage_num": "3", "stage_title": "Endpoint R√©ception User Request", "todos": ["Cr√©er route POST `/api/mcp/receive-request`", "Param√®tres d'entr√©e : `{\"record_id\", \"session_id\", \"user_request\"}`", "Valider les param√®tres requis (record_id et user_request obligatoires)", "Logger la r√©ception : `[INFO] Request received - record_id: {}, session_id: {}`", "Stocker temporairement la requ√™te (queue Redis)", "Retourner accus√© de r√©ception imm√©diat : `{\"status\": \"received\", \"request_id\": \"...\"}`", "G√©rer les erreurs de validation (400 Bad Request)", "Tester avec le mock Apex"], "code_blocks": []}, {"ticket_id": "4.1", "ticket_title": "Session Validator & Router", "duration": "0.5j", "description": "Logique de v√©rification de session et routage du flow", "stage_num": "4", "stage_title": "Syst√®me V√©rification Session et Routage", "todos": ["Cr√©er classe `SessionRouter`", "Impl√©menter `validate_and_route(record_id, session_id, user_request)` :", "D√©velopper `route_to_initialization(record_id, user_request)` :", "Appelle endpoint r√©cup√©ration Salesforce data", "Cr√©e nouvelle session", "Passe au preprocessing complet", "D√©velopper `route_to_continuation(session_id, user_request)` :", "R√©cup√®re context existant", "Ajoute user_request √† l'historique", "Passe au prompt building (skip preprocessing)", "Ajouter logging d√©taill√© du routage", "Tester les deux branches du flow"], "code_blocks": []}, {"ticket_id": "4.2", "ticket_title": "Workflow Orchestrator", "duration": "0.5j", "description": "Orchestrateur qui coordonne l'ex√©cution s√©quentielle des √©tapes", "stage_num": "4", "stage_title": "Syst√®me V√©rification Session et Routage", "todos": ["Cr√©er classe `WorkflowOrchestrator`", "Impl√©menter `execute_workflow(request_data)` :", "√âtape 1 : Validation & Routing", "√âtape 2 : Preprocessing (si nouvelle session)", "√âtape 3 : Prompt Building", "√âtape 4 : Envoi vers Langgraph", "√âtape 5 : Traitement r√©ponse", "Ajouter gestion d'erreurs √† chaque √©tape (try/catch)", "Impl√©menter rollback en cas d'√©chec", "Logger chaque transition d'√©tape", "Cr√©er m√©canisme de pause/reprise (pour debugging)", "Tester le workflow complet end-to-end"], "code_blocks": []}, {"ticket_id": "5.1", "ticket_title": "Document Preprocessor", "duration": "0.5j", "description": "Traiter et normaliser les documents re√ßus de Salesforce", "stage_num": "5", "stage_title": "Preprocessing Data Salesforce", "todos": ["Cr√©er classe `DocumentPreprocessor`", "Impl√©menter `process_documents(documents_list)` :", "D√©coder base64 ‚Üí fichiers binaires", "Valider format (PDF, JPG, PNG)", "D√©tecter orientation et corriger si n√©cessaire", "Am√©liorer qualit√© image (contraste, r√©solution)", "G√©n√©rer thumbnails pour UI", "D√©velopper `extract_document_metadata(document)` :", "Nom fichier, taille, type MIME", "Nombre de pages (pour PDF)", "Dimensions (pour images)", "Cr√©er `validate_document_quality(document)` ‚Üí score qualit√©", "Retourner liste de documents normalis√©s", "Tester avec documents de qualit√© variable"], "code_blocks": []}, {"ticket_id": "5.2", "ticket_title": "Fields Dictionary Preprocessor", "duration": "0.5j", "description": "Pr√©parer et enrichir le dictionnaire des champs √† remplir", "stage_num": "5", "stage_title": "Preprocessing Data Salesforce", "todos": ["Cr√©er classe `FieldsDictionaryPreprocessor`", "Impl√©menter `prepare_fields_dictionary(fields_to_fill)` :", "Identifier champs vides vs pr√©remplis", "Ajouter contexte m√©tier par type de champ", "G√©n√©rer exemples de valeurs attendues", "D√©finir r√®gles de validation par champ", "D√©velopper `enrich_field_metadata(field)` :", "Cr√©er templates d'enrichissement par record_type", "Impl√©menter `prioritize_fields()` ‚Üí ordre de remplissage", "Retourner dictionnaire enrichi", "Tester avec diff√©rents types de formulaires"], "code_blocks": []}, {"ticket_id": "5.3", "ticket_title": "Preprocessing Pipeline", "duration": "0.5j", "description": "Pipeline complet de preprocessing coordonnant documents et fields", "stage_num": "5", "stage_title": "Preprocessing Data Salesforce", "todos": ["Cr√©er classe `PreprocessingPipeline`", "Impl√©menter `execute_preprocessing(salesforce_data)` :", "√âtape 1 : Process documents", "√âtape 2 : Prepare fields dictionary", "√âtape 3 : Cross-validation (coh√©rence)", "√âtape 4 : G√©n√©ration r√©sum√© contexte", "D√©velopper `generate_context_summary()` :", "Type de record et objectif", "Documents disponibles", "Champs √† extraire", "R√®gles m√©tier applicables", "Cr√©er `prepare_for_llm()` ‚Üí format optimis√© pour prompt", "Ajouter m√©triques : temps preprocessing, taille data", "Retourner objet `PreprocessedData`", "Tester performance sur large volume"], "code_blocks": []}, {"ticket_id": "6.1", "ticket_title": "Prompt Template Engine", "duration": "0.5j", "description": "Syst√®me de templates pour g√©n√©rer des prompts dynamiques", "stage_num": "6", "stage_title": "Cr√©ation Prompt", "todos": ["Cr√©er classe `PromptTemplateEngine`", "D√©finir templates par sc√©nario :", "Template \"Initialization\" (premi√®re requ√™te)", "Template \"Extraction\" (remplissage champs)", "Template \"Clarification\" (questions user)", "Template \"Validation\" (v√©rification donn√©es)", "Impl√©menter `load_template(scenario_type)` ‚Üí template Jinja2", "Cr√©er variables de template :", "`{{context_summary}}`", "`{{documents_description}}`", "`{{fields_to_fill}}`", "`{{user_request}}`", "`{{conversation_history}}`", "`{{instructions}}`", "D√©velopper `render_template(template, variables)` ‚Üí prompt final", "Tester g√©n√©ration pour chaque sc√©nario"], "code_blocks": []}, {"ticket_id": "6.2", "ticket_title": "Prompt Builder - Nouvelle Session", "duration": "0.5j", "description": "Construire le prompt pour une nouvelle session (route initialization)", "stage_num": "6", "stage_title": "Cr√©ation Prompt", "todos": ["Cr√©er m√©thode `build_initialization_prompt(preprocessed_data, user_request)`", "Structurer le prompt :", "Impl√©menter `format_documents_section(documents)`", "Impl√©menter `format_fields_section(fields_dictionary)`", "Ajouter instructions sp√©cifiques par record_type", "Optimiser longueur prompt (limite tokens)", "Tester g√©n√©ration et qualit√© du prompt"], "code_blocks": []}, {"ticket_id": "6.3", "ticket_title": "Prompt Builder - Session Continue", "duration": "0.5j", "description": "Construire le prompt pour une session existante (route continuation)", "stage_num": "6", "stage_title": "Cr√©ation Prompt", "todos": ["Cr√©er m√©thode `build_continuation_prompt(session_context, user_request)`", "Structurer le prompt :", "Impl√©menter `summarize_conversation_history(history)` (max 5 derniers √©changes)", "D√©velopper `format_extracted_data(extracted_fields)`", "G√©rer cas o√π historique est long (truncation intelligente)", "Ajouter contexte de validation si corrections demand√©es", "Tester avec conversations complexes"], "code_blocks": []}, {"ticket_id": "6.4", "ticket_title": "Prompt Optimizer", "duration": "0.5j", "description": "Optimiser les prompts pour performance et co√ªt", "stage_num": "6", "stage_title": "Cr√©ation Prompt", "todos": ["Cr√©er classe `PromptOptimizer`", "Impl√©menter `count_tokens(prompt)` ‚Üí estimation tokens", "D√©velopper `compress_prompt_if_needed(prompt, max_tokens)` :", "R√©duire historique conversation", "R√©sumer documents longs", "Simplifier instructions redondantes", "Cr√©er `validate_prompt_quality(prompt)` :", "V√©rifier pr√©sence √©l√©ments cl√©s", "D√©tecter ambigu√Øt√©s", "Scorer clart√© instructions", "Impl√©menter cache de prompts similaires", "Ajouter m√©triques : tokens utilis√©s, co√ªt estim√©", "Tester optimisation sur prompts volumineux"], "code_blocks": []}, {"ticket_id": "7.1", "ticket_title": "MCP Client Configuration", "duration": "0.5j", "description": "Configurer le client MCP pour communication avec backend Langgraph", "stage_num": "7", "stage_title": "MCP Transfert vers Langgraph", "todos": ["Installer SDK MCP (Model Context Protocol)", "Configurer connexion au serveur Langgraph :", "URL endpoint", "Authentification (API key/token)", "Timeout et retry policy", "Cr√©er classe `MCPClient`", "Impl√©menter `connect()` et `disconnect()`", "Ajouter health check : `ping_langgraph_backend()`", "Configurer pool de connexions (pour performance)", "Tester connexion et latence"], "code_blocks": []}, {"ticket_id": "7.2", "ticket_title": "Message Formatter MCP", "duration": "0.5j", "description": "Formater les messages selon le protocole MCP", "stage_num": "7", "stage_title": "MCP Transfert vers Langgraph", "todos": ["Cr√©er classe `MCPMessageFormatter`", "D√©finir structure message MCP :", "Impl√©menter `format_message(prompt, context, metadata)`", "D√©velopper `serialize_documents_for_mcp(documents)` (encodage adapt√©)", "Cr√©er `add_metadata(message, metadata_dict)`", "Valider taille message (limite protocole MCP)", "Tester s√©rialisation et d√©s√©rialisation"], "code_blocks": []}, {"ticket_id": "7.3", "ticket_title": "MCP Sender & Response Handler", "duration": "0.5j", "description": "Envoyer les messages via MCP et g√©rer les r√©ponses", "stage_num": "7", "stage_title": "MCP Transfert vers Langgraph", "todos": ["Cr√©er classe `MCPSender`", "Impl√©menter `send_to_langgraph(mcp_message)` :", "Envoie message via MCP", "Attend r√©ponse (synchrone ou asynchrone)", "Retourne response_object", "D√©velopper `handle_langgraph_response(response)` :", "Parser la r√©ponse JSON", "Extraire extracted_data et confidence_scores", "Valider structure de la r√©ponse", "Impl√©menter gestion erreurs :", "Timeout ‚Üí retry avec backoff", "Erreur serveur ‚Üí log et alerte", "R√©ponse invalide ‚Üí demande clarification", "Ajouter logging d√©taill√© des √©changes", "Cr√©er m√©triques : temps round-trip, taux succ√®s", "Tester avec mock de Langgraph"], "code_blocks": []}, {"ticket_id": "7.4", "ticket_title": "Async Task Queue", "duration": "0.5j", "description": "Queue asynchrone pour g√©rer les envois MCP (√©viter blocking)", "stage_num": "7", "stage_title": "MCP Transfert vers Langgraph", "todos": ["Installer Celery ou RQ (Redis Queue)", "Configurer Redis comme message broker", "Cr√©er task asynchrone `@task send_to_langgraph_async(message)` :", "Ex√©cute envoi MCP en background", "Met √† jour status dans DB", "Callback sur completion", "Impl√©menter `enqueue_request(mcp_message)` ‚Üí retourne task_id", "D√©velopper `check_task_status(task_id)` ‚Üí pending|completed|failed", "Cr√©er endpoint `/api/task-status/{task_id}` pour polling", "Configurer retry automatique en cas d'√©chec", "Tester charge avec 100+ requ√™tes simultan√©es"], "code_blocks": []}, {"ticket_id": "8.1", "ticket_title": "Architecture Langgraph State", "duration": "0.5j", "description": "D√©finir la structure du State et initialiser le graph", "stage_num": "8", "stage_title": "D√©veloppement Langgraph Backend", "todos": ["Cr√©er classe `OptiClaimsState(TypedDict)` :", "Initialiser `StateGraph(OptiClaimsState)`", "D√©finir les nodes du graph :", "`ocr_extraction`", "`field_mapping`", "`data_extraction`", "`supervision_validation`", "`response_formatting`", "Configurer les edges conditionnels", "Compiler le graph : `graph.compile()`", "Tester cr√©ation et invocation du graph"], "code_blocks": []}, {"ticket_id": "8.2", "ticket_title": "OCR Manager Node", "duration": "0.5j", "description": "Node Langgraph pour extraction OCR avec Sentra GPT", "stage_num": "8", "stage_title": "D√©veloppement Langgraph Backend", "todos": ["Cr√©er fonction `ocr_extraction_node(state: OptiClaimsState)` :", "R√©cup√®re documents depuis state", "Appelle Sentra GPT pour OCR", "Extrait texte brut de chaque document", "Consolide textes multiples", "Met √† jour `state[\"raw_ocr_text\"]`", "Int√©grer API Sentra GPT :", "Authentification", "Envoi documents encod√©s", "R√©ception r√©sultats OCR", "Impl√©menter scoring confiance OCR par document", "G√©rer erreurs OCR (document illisible)", "Ajouter logging : tokens utilis√©s, temps traitement", "Tester avec documents de qualit√© variable"], "code_blocks": []}, {"ticket_id": "8.3", "ticket_title": "Mapping Manager Node", "duration": "0.5j", "description": "Node pour mapper les donn√©es extraites aux champs Salesforce", "stage_num": "8", "stage_title": "D√©veloppement Langgraph Backend", "todos": ["Cr√©er fonction `field_mapping_node(state: OptiClaimsState)` :", "R√©cup√®re `raw_ocr_text` et `fields_dictionary`", "Appelle Sentra GPT avec prompt de mapping", "Identifie correspondances texte OCR ‚Üî champs SF", "G√©n√®re mapping structur√©", "Met √† jour state avec mappings", "D√©velopper prompt de mapping :", "Impl√©menter validation des mappings", "G√©rer cas o√π champ non trouv√© dans OCR", "Tester avec diff√©rents types de documents"], "code_blocks": []}, {"ticket_id": "8.4", "ticket_title": "Data Extraction Node", "duration": "0.5j", "description": "Node pour extraire et structurer les donn√©es finales", "stage_num": "8", "stage_title": "D√©veloppement Langgraph Backend", "todos": ["Cr√©er fonction `data_extraction_node(state: OptiClaimsState)` :", "Utilise les mappings pour extraire valeurs", "Applique formatage par type de champ (dates, montants)", "Normalise les donn√©es (trim, uppercase, etc.)", "Calcule confiance par champ", "Met √† jour `state[\"extracted_data\"]`", "Impl√©menter extracteurs sp√©cialis√©s :", "`extract_amount(text)` ‚Üí float", "`extract_date(text)` ‚Üí ISO format", "`extract_name(text)` ‚Üí capitalized string", "G√©rer ambigu√Øt√©s (plusieurs dates/montants dans le texte)", "Cr√©er syst√®me de scoring multi-crit√®res :", "Clart√© de la source", "Coh√©rence avec format attendu", "Validation crois√©e", "Tester extraction sur cas complexes"], "code_blocks": []}, {"ticket_id": "8.5", "ticket_title": "Superviseur Node", "duration": "0.5j", "description": "Node de validation et contr√¥le qualit√© final", "stage_num": "8", "stage_title": "D√©veloppement Langgraph Backend", "todos": ["Cr√©er fonction `supervision_validation_node(state: OptiClaimsState)` :", "R√©cup√®re `extracted_data` et `confidence_scores`", "Appelle Sentra GPT pour validation s√©mantique", "V√©rifie coh√©rence globale des donn√©es", "D√©tecte anomalies (montant n√©gatif, date future, etc.)", "Met √† jour `state[\"validation_results\"]`", "Impl√©menter r√®gles de validation :", "D√©velopper `calculate_global_quality_score(validation_results)` ‚Üí 0-100", "Cr√©er logique conditionnelle :", "Si score > 85% ‚Üí passer √† response", "Si score 50-85% ‚Üí signaler champs incertains", "Si score < 50% ‚Üí demander clarification user", "Tester validation avec donn√©es correctes et incorrectes"], "code_blocks": []}, {"ticket_id": "8.6", "ticket_title": "Response Formatting Node", "duration": "0.5j", "description": "Node pour formater la r√©ponse finale destin√©e √† Salesforce", "stage_num": "8", "stage_title": "D√©veloppement Langgraph Backend", "todos": ["Cr√©er fonction `response_formatting_node(state: OptiClaimsState)` :", "Pr√©pare r√©ponse structur√©e pour UI/Salesforce", "Inclut extracted_data + confidence + validation", "Ajoute suggestions si donn√©es incompl√®tes", "Formate message pour l'utilisateur", "D√©finir structure de r√©ponse :", "Impl√©menter `generate_user_message(validation_results)`", "Cr√©er suggestions automatiques si donn√©es manquantes", "Ajouter m√©tadonn√©es : temps traitement, tokens utilis√©s", "Tester formatage pour diff√©rents statuts"], "code_blocks": []}, {"ticket_id": "8.7", "ticket_title": "Langgraph Workflow Integration", "duration": "0.5j", "description": "Assembler tous les nodes dans le workflow complet", "stage_num": "8", "stage_title": "D√©veloppement Langgraph Backend", "todos": ["Configurer le flow du graph :", "Impl√©menter `should_retry(state)` ‚Üí d√©cision conditionnelle", "Configurer checkpointing pour √©tat persistant", "Ajouter logging √† chaque transition", "Cr√©er m√©canisme de pause/debug", "Tester workflow complet end-to-end"], "code_blocks": []}, {"ticket_id": "8.8", "ticket_title": "Memory & State Persistence", "duration": "0.5j", "description": "G√©rer la persistance du state Langgraph entre invocations", "stage_num": "8", "stage_title": "D√©veloppement Langgraph Backend", "todos": ["Configurer MemorySaver pour Langgraph :", "Impl√©menter sauvegarde state apr√®s chaque node", "Cr√©er `load_state_from_session(session_id)` ‚Üí restaure state", "D√©velopper `save_state_to_session(session_id, state)`", "G√©rer historique des states (pour rollback si n√©cessaire)", "Configurer nettoyage automatique des vieux states (>24h)", "Tester persistance avec interruptions volontaires"], "code_blocks": []}, {"ticket_id": "9.1", "ticket_title": "Conversation History Logger", "duration": "0.5j", "description": "Logger tous les messages √©chang√©s avec session_id", "stage_num": "9", "stage_title": "Monitoring des √âchanges", "todos": ["Cr√©er table/collection `conversation_logs` :", "Cr√©er classe `ConversationLogger`", "Impl√©menter `log_user_message(session_id, message)`", "Impl√©menter `log_assistant_response(session_id, response, metadata)`", "D√©velopper `get_conversation_history(session_id)` ‚Üí liste messages", "Ajouter index sur session_id pour performance", "Tester insertion et r√©cup√©ration"], "code_blocks": []}, {"ticket_id": "9.2", "ticket_title": "Request Tracking System", "duration": "0.5j", "description": "Tracker chaque requ√™te avec m√©tadonn√©es compl√®tes", "stage_num": "9", "stage_title": "Monitoring des √âchanges", "todos": ["Cr√©er table `request_tracking` :", "Impl√©menter `create_request_track(session_id, user_request)`", "D√©velopper `update_request_status(request_id, status, data)`", "Cr√©er `finalize_request_track(request_id, response, metrics)`", "Ajouter calcul automatique processing_time", "Impl√©menter queries d'analyse :", "Temps moyen par type de requ√™te", "Taux de succ√®s/√©chec", "Distribution des quality scores", "Tester tracking workflow complet"], "code_blocks": []}, {"ticket_id": "9.3", "ticket_title": "Monitoring Dashboard Backend", "duration": "0.5j", "description": "API pour alimenter le dashboard de monitoring", "stage_num": "9", "stage_title": "Monitoring des √âchanges", "todos": ["Cr√©er route GET `/api/monitoring/sessions/active` :", "Retourne liste sessions actives avec derni√®re activit√©", "Cr√©er route GET `/api/monitoring/session/{session_id}/history` :", "Retourne historique complet d'une session", "Cr√©er route GET `/api/monitoring/stats` :", "Impl√©menter route GET `/api/monitoring/requests/recent` :", "50 derni√®res requ√™tes avec status", "Cr√©er route GET `/api/monitoring/errors` :", "Liste erreurs r√©centes avec d√©tails", "Ajouter pagination et filtres (par date, status, record_id)", "Tester performance des queries"], "code_blocks": []}, {"ticket_id": "9.4", "ticket_title": "Real-time Monitoring avec WebSocket", "duration": "0.5j", "description": "Streaming temps r√©el des √©v√©nements pour le dashboard", "stage_num": "9", "stage_title": "Monitoring des √âchanges", "todos": ["Configurer WebSocket server (Socket.IO ou native)", "Cr√©er endpoint WebSocket `/ws/monitoring`", "Impl√©menter √©v√©nements temps r√©el :", "`new_request` ‚Üí nouvelle requ√™te re√ßue", "`request_completed` ‚Üí traitement termin√©", "`request_failed` ‚Üí erreur survenue", "`session_created` ‚Üí nouvelle session", "D√©velopper `broadcast_event(event_type, data)` :", "Envoie √† tous les clients connect√©s", "Cr√©er m√©canisme de subscription par session_id", "Impl√©menter heartbeat pour maintenir connexion", "Tester avec client WebSocket (navigateur ou Postman)"], "code_blocks": []}, {"ticket_id": "10.1", "ticket_title": "Response Formatter for Salesforce", "duration": "0.5j", "description": "Formater la r√©ponse Langgraph au format attendu par Salesforce", "stage_num": "10", "stage_title": "Endpoint Envoi R√©ponse Salesforce", "todos": ["Cr√©er classe `SalesforceResponseFormatter`", "Impl√©menter `format_for_salesforce(langgraph_response)` :", "D√©velopper `map_field_names_to_salesforce_api(extracted_data)`", "Impl√©menter conversion types de donn√©es (date format, currency)", "Ajouter flag `requires_review` si confiance < seuil", "Cr√©er r√©sum√© validation pour UI Salesforce", "Tester formatage pour diff√©rents sc√©narios"], "code_blocks": []}, {"ticket_id": "10.2", "ticket_title": "Mock API Salesforce - Receive Response", "duration": "0.5j", "description": "Mock de l'API Salesforce qui re√ßoit la r√©ponse", "stage_num": "10", "stage_title": "Endpoint Envoi R√©ponse Salesforce", "todos": ["Cr√©er route POST `/mock/salesforce/receive-response`", "Impl√©menter validation de la r√©ponse re√ßue :", "V√©rifier structure JSON", "Valider pr√©sence champs obligatoires", "Tester coh√©rence des donn√©es", "Simuler mise √† jour du record Salesforce", "Logger la r√©ception : `[MOCK SF] Response received for record {record_id}`", "Retourner accus√© r√©ception :", "Cr√©er endpoint GET `/mock/salesforce/record/{record_id}` pour v√©rifier MAJ", "Tester r√©ception et traitement"], "code_blocks": []}, {"ticket_id": "10.3", "ticket_title": "Endpoint MCP - Send Response to Salesforce", "duration": "0.5j", "description": "Endpoint qui envoie la r√©ponse finale vers Salesforce", "stage_num": "10", "stage_title": "Endpoint Envoi R√©ponse Salesforce", "todos": ["Cr√©er route POST `/api/mcp/send-response-salesforce`", "Param√®tres d'entr√©e : `{\"langgraph_response\": {...}}`", "Impl√©menter `send_to_salesforce(formatted_response)` :", "Appelle API Salesforce (ou mock)", "G√®re authentification Salesforce", "Envoie donn√©es format√©es", "Attend confirmation", "D√©velopper retry logic avec backoff exponentiel :", "Max 3 tentatives", "D√©lai : 2s, 4s, 8s", "Ajouter flag `response_sent` dans tracking :", "Logger chaque tentative et r√©sultat", "G√©rer erreurs Salesforce (record locked, validation rules)", "Tester avec le mock Salesforce"], "code_blocks": []}, {"ticket_id": "10.4", "ticket_title": "Response Delivery Monitor", "duration": "0.5j", "description": "Syst√®me de monitoring de la livraison des r√©ponses", "stage_num": "10", "stage_title": "Endpoint Envoi R√©ponse Salesforce", "todos": ["Cr√©er classe `ResponseDeliveryMonitor`", "Impl√©menter `track_delivery(request_id, status)` :", "`pending` ‚Üí en attente envoi", "`sending` ‚Üí envoi en cours", "`delivered` ‚Üí livr√© avec succ√®s", "`failed` ‚Üí √©chec apr√®s retries", "D√©velopper `check_undelivered_responses()` :", "Query les r√©ponses non livr√©es", "Trigger retry automatique", "Alerte si √©chec r√©p√©t√©", "Cr√©er job p√©riodique (cron) :", "Toutes les 5 minutes", "V√©rifie r√©ponses pending > 10 minutes", "Relance envoi", "Impl√©menter m√©triques :", "Taux de livraison (delivered / total)", "Temps moyen de livraison", "Nombre de retries n√©cessaires", "Cr√©er endpoint `/api/monitoring/delivery-status`", "Tester avec sc√©narios d'√©chec r√©seau"], "code_blocks": []}, {"ticket_id": "10.5", "ticket_title": "End-to-End Integration Test", "duration": "0.5j", "description": "Test complet du flux depuis Apex jusqu'√† r√©ponse Salesforce", "stage_num": "10", "stage_title": "Endpoint Envoi R√©ponse Salesforce", "todos": ["Cr√©er script de test E2E `test_full_workflow.py` :", "Tester avec 3 sc√©narios :", "Sc√©nario 1 : Nouvelle session, extraction compl√®te", "Sc√©nario 2 : Session continue, clarification", "Sc√©nario 3 : √âchec extraction, retry", "Mesurer temps end-to-end pour chaque sc√©nario", "Valider tous les logs g√©n√©r√©s", "V√©rifier √©tat final dans Salesforce (mock)", "Documenter r√©sultats et m√©triques"], "code_blocks": []}], "stages": [{"stage_num": "1", "stage_title": "Endpoint R√©cup√©ration Data Salesforce", "tickets": ["1.1", "1.2"]}, {"stage_num": "2", "stage_title": "Syst√®me de Gestion de Session", "tickets": ["2.1", "2.2"]}, {"stage_num": "3", "stage_title": "Endpoint R√©ception User Request", "tickets": ["3.1", "3.2"]}, {"stage_num": "4", "stage_title": "Syst√®me V√©rification Session et Routage", "tickets": ["4.1", "4.2"]}, {"stage_num": "5", "stage_title": "Preprocessing Data Salesforce", "tickets": ["5.1", "5.2", "5.3"]}, {"stage_num": "6", "stage_title": "Cr√©ation Prompt", "tickets": ["6.1", "6.2", "6.3", "6.4"]}, {"stage_num": "7", "stage_title": "MCP Transfert vers Langgraph", "tickets": ["7.1", "7.2", "7.3", "7.4"]}, {"stage_num": "8", "stage_title": "D√©veloppement Langgraph Backend", "tickets": ["8.1", "8.2", "8.3", "8.4", "8.5", "8.6", "8.7", "8.8"]}, {"stage_num": "9", "stage_title": "Monitoring des √âchanges", "tickets": ["9.1", "9.2", "9.3", "9.4"]}, {"stage_num": "10", "stage_title": "Endpoint Envoi R√©ponse Salesforce", "tickets": ["10.1", "10.2", "10.3", "10.4", "10.5"]}], "meta": {"total_tickets": 36}};

/* --- APP LOGIC --- */

// State
let tickets = [...DATA.tickets];
let deletedIds = new Set(JSON.parse(localStorage.getItem('opticl_del_v2') || '[]'));
let activeTicketId = null;

// DOM Elements
const elBoard = document.getElementById('boardContainer');
const elDrawer = document.getElementById('ticketDrawer');
const elBackdrop = document.getElementById('drawerBackdrop');
const elSearch = document.getElementById('searchInput');
const elGlobalProgress = document.getElementById('globalProgress');

// Init
function init() {
  renderBoard();
  updateProgress();
  
  // Event Listeners
  elSearch.addEventListener('input', () => renderBoard());
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);
  document.getElementById('closeDrawer').addEventListener('click', closeDrawer);
  elBackdrop.addEventListener('click', closeDrawer);
  document.addEventListener('keydown', (e) => e.key === 'Escape' && closeDrawer());
  
  document.getElementById('btnDelete').addEventListener('click', () => {
    if(activeTicketId) {
      if(confirm('Supprimer ce ticket ?')) {
        deletedIds.add(activeTicketId);
        localStorage.setItem('opticl_del_v2', JSON.stringify([...deletedIds]));
        closeDrawer();
        renderBoard();
        updateProgress();
      }
    }
  });

  // Restore theme
  if(localStorage.getItem('opticl_theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
}

function updateProgress() {
  const total = DATA.tickets.length;
  const current = tickets.filter(t => !deletedIds.has(t.ticket_id)).length;
  // Just a visual fake progress for "work done" vs "total scope" logic, 
  // or simply fill 100% if we consider "available tickets". 
  // Let's animate it to 100% on load for effect.
  setTimeout(() => {
    elGlobalProgress.style.width = '100%'; 
  }, 200);
}

function toggleTheme() {
  const isDark = document.body.getAttribute('data-theme') === 'dark';
  document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
  localStorage.setItem('opticl_theme', isDark ? 'light' : 'dark');
}

function renderBoard() {
  const query = elSearch.value.toLowerCase();
  
  // Group by stage
  const stages = DATA.stages.sort((a,b) => parseInt(a.stage_num) - parseInt(b.stage_num));
  
  elBoard.innerHTML = stages.map(stage => {
    const stageTickets = tickets.filter(t => 
      t.stage_num === stage.stage_num &&
      !deletedIds.has(t.ticket_id) && 
      (t.ticket_title.toLowerCase().includes(query) || t.description.toLowerCase().includes(query))
    );
    
    // Don't hide empty stages, just show them empty (better structure)
    return `
      <div class="stage-col">
        <div class="stage-header">
          <div class="stage-title">
            <span style="color:var(--text-light)">${stage.stage_num}.</span>
            ${stage.stage_title}
          </div>
          <span class="stage-badge">${stageTickets.length}</span>
        </div>
        <div class="stage-body">
          ${stageTickets.map(t => renderCard(t)).join('')}
        </div>
      </div>
    `;
  }).join('');
  
  // Add listeners to cards
  document.querySelectorAll('.ticket-card').forEach(card => {
    card.addEventListener('click', () => openDrawer(card.dataset.id));
  });
}

function renderCard(t) {
  const todoCount = t.todos ? t.todos.length : 0;
  return `
    <article class="ticket-card" data-id="${t.ticket_id}">
      <div class="card-top">
        <span class="card-id">#${t.ticket_id}</span>
        <span class="card-duration">‚è± ${t.duration}</span>
      </div>
      <div class="card-title">${t.ticket_title}</div>
      <div class="card-desc">${t.description}</div>
      <div class="card-meta">
        <div class="meta-item">
           üìã ${todoCount} t√¢ches
        </div>
        <div class="meta-item" style="margin-left:auto; color:var(--primary)">
          Voir d√©tails ‚Üí
        </div>
      </div>
    </article>
  `;
}

function openDrawer(id) {
  const t = tickets.find(x => x.ticket_id === id);
  if(!t) return;
  
  activeTicketId = id;
  
  // Fill Content
  document.getElementById('d-title').textContent = t.ticket_title;
  document.getElementById('d-id').textContent = `Ticket ID: ${t.ticket_id} ‚Ä¢ √âtape ${t.stage_num}`;
  document.getElementById('d-desc').textContent = t.description;
  
  // Todos
  const todoHTML = (t.todos || []).map(todo => `
    <li class="todo-item">
      <div class="todo-check"></div>
      <span style="font-size:13px; color:var(--text-main)">${todo}</span>
    </li>
  `).join('');
  document.getElementById('d-todos').innerHTML = todoHTML || '<li class="todo-item" style="color:var(--text-light)">Aucune t√¢che list√©e.</li>';
  
  // Code Blocks
  const codeHTML = (t.code_blocks || []).length > 0 
    ? t.code_blocks.map((b, i) => `
        <div class="code-block">
          <div class="code-header">
            <span>Snippet ${i+1} (${b.lang || 'text'})</span>
            <button style="border:none; bg:transparent; cursor:pointer;" onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText)">üìã</button>
          </div>
          <pre>${b.code}</pre>
        </div>
      `).join('')
    : '<div style="font-style:italic; color:var(--text-light); font-size:13px;">Aucun extrait de code.</div>';
    
  document.getElementById('d-code').innerHTML = codeHTML;

  // Open UI
  elBackdrop.classList.add('open');
  elDrawer.classList.add('open');
}

function closeDrawer() {
  elBackdrop.classList.remove('open');
  elDrawer.classList.remove('open');
  activeTicketId = null;
}

// Start
init();

</script>
</body>
</html>